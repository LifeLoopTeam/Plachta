@using System.Globalization
@using Plachta.Shared.BO;
@using Plachta.Client.Components;
@using Plachta.Client.Helpers
@using Plachta.Client.Pages;
@using BlazorContextMenu

@inject IJSRuntime JSRuntime

<div class="den">
    <div class="title">
        @Den.Poradie <br />
        Test
    </div>
    <div class="aktivity dropzone"
         @ondragenter="HandleDragEnter"
         @ondragover="e => DragOver(e)"
         @ondragover:preventDefault="_dropAllowed"
         @ondrop="e => HandleDrop(e)"
         @ref=AktivityDiv>
        @foreach (var aktivita in Den.Aktivity)
        {
            <ContextMenuTrigger MenuId="myMenu" Data="aktivita">
                <PlachtaAktivitaView Aktivita="@aktivita"></PlachtaAktivitaView>
            </ContextMenuTrigger>
        }
    </div>
</div>



@code{
    ElementReference AktivityDiv;

    [CascadingParameter] Plachtovac Plachtovac { get; set; }

    [Parameter]
    public Den Den { get; set; }

    private BoundingClientRect denBounding;
    private bool _dropAllowed = false;

    protected override void OnAfterRender(bool firstRender)
    {
        base.OnAfterRender(firstRender);
        Den.PropertyChanged += (o, e) => StateHasChanged();
    }


    private async Task HandleDragEnter()
    {
        denBounding = await JSRuntime.InvokeAsync<BoundingClientRect>("Plachtovac.getBoundingClientRect", AktivityDiv);
    }

    private async Task HandleDrop(DragEventArgs dragEventArgs)
    {
        var left = ((dragEventArgs.ClientX - denBounding.x - Plachtovac.SelectedAktivita.SelectionOffset) / denBounding.width);
        Plachtovac.Rozvrh.PresunAktivitu(Plachtovac.SelectedAktivita.Aktivita, Den, new TimeSpan((int)(8 + ((left * 12 * 60) / 60)), (int)((left * 12 * 60) % 60), 0));
    }

    private void DragOver(DragEventArgs dragEventArgs)
    {
        dragEventArgs.DataTransfer.DropEffect = "move";


        var left = ((dragEventArgs.ClientX - denBounding.x - Plachtovac.SelectedAktivita.SelectionOffset) / denBounding.width);

        if (Den.Koliduje(new TimeSpan((int)(8 + ((left * 12 * 60) / 60)), (int)((left * 12 * 60) % 60), 0), Plachtovac.SelectedAktivita.Aktivita))
        {
            _dropAllowed = false;
            return;
        }
        _dropAllowed = true;
    }
}
